{% extends 'core/base_app.html' %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Painel de Planejamentos</h2>
    <a href="#" class="btn btn-principal-acao">
        <i class="bi bi-plus-circle-fill me-1"></i>
        <span>Criar Planejamento</span>
    </a>
</div>

<div class="accordion accordion-flush" id="kanbanAccordion">

    {% comment %} COLUNA A FAZER {% endcomment %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingAFazer">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAFazer" aria-expanded="true" aria-controls="collapseAFazer">
                <span class="badge bg-secondary me-2">{{ count_a_fazer }}</span> A Fazer / Planejamento
            </button>
        </h2>
        <div id="collapseAFazer" class="accordion-collapse collapse show" aria-labelledby="headingAFazer" data-bs-parent="#kanbanAccordion">
            <div class="accordion-body">
                {% for area in areas_a_fazer %}
                    <div class="card card-obra card-obra-area mb-3">
                        <a href="{% url 'mapa' %}?area_id={{ area.id }}" class="stretched-link"></a>
                        <div class="card-body">
                            <h6 class="card-title mb-1"><strong>Área:</strong> {{ area.nome }}</h6>
                            <p class="mb-1 small"><strong>Status:</strong> {{ area.get_status_display }}</p>
                            <p class="mb-1 small"><strong>Árvores no local:</strong> {{ area.contagem_arvores }}</p>
                            <div class="d-flex justify-content-between card-footer-text mt-2 pt-2 border-top">
                                <span>Projeto #{{ area.projeto.id }}</span>
                                <span class="text-muted">{{ area.data_criacao|date:"d/m/Y" }}</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                {% for solicitacao in solicitacoes_a_fazer %}
                     <div class="card card-obra card-obra-solicitacao mb-3">
                        <a href="{% url 'solicitacao_update' pk=solicitacao.pk %}" class="stretched-link"></a>
                        <div class="card-body">
                            <h6 class="card-title mb-1"><strong>Solicitação:</strong> #{{ solicitacao.id }} - {{ solicitacao.get_tipo_display }}</h6>
                            <p class="mb-1 small text-muted">{{ solicitacao.descricao|truncatewords:15 }}</p>
                            <div class="d-flex justify-content-between card-footer-text mt-2 pt-2 border-top">
                                <span>Por: {{ solicitacao.cidadao.username }}</span>
                                <span class="text-muted">{{ solicitacao.data_criacao|date:"d/m/Y" }}</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                {% if not areas_a_fazer and not solicitacoes_a_fazer %}
                    <p class="text-center text-muted small p-3">Nenhuma tarefa aqui.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {% comment %} COLUNA EM EXECUÇÃO {% endcomment %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingEmExecucao">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmExecucao" aria-expanded="false" aria-controls="collapseEmExecucao">
                <span class="badge bg-primary me-2">{{ count_em_execucao }}</span> Em Execução
            </button>
        </h2>
        <div id="collapseEmExecucao" class="accordion-collapse collapse" aria-labelledby="headingEmExecucao" data-bs-parent="#kanbanAccordion">
            <div class="accordion-body">
                {% for area in areas_em_execucao %}
                    <div class="card card-obra card-obra-area mb-3">
                        <a href="{% url 'mapa' %}?area_id={{ area.id }}" class="stretched-link"></a>
                        <div class="card-body">
                            <h6 class="card-title mb-1"><strong>Área:</strong> {{ area.nome }}</h6>
                            <p class="mb-1 small"><strong>Responsável:</strong> {{ area.responsavel.username|default:"N/D" }}</p>
                            <p class="mb-1 small"><strong>Árvores no local:</strong> {{ area.contagem_arvores }}</p>
                            <div class="d-flex justify-content-between card-footer-text mt-2 pt-2 border-top">
                                <span>Projeto #{{ area.projeto.id }}</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                {% for solicitacao in solicitacoes_em_execucao %}
                     <div class="card card-obra card-obra-solicitacao mb-3">
                        <a href="{% url 'solicitacao_update' pk=solicitacao.pk %}" class="stretched-link"></a>
                        <div class="card-body">
                            <h6 class="card-title mb-1"><strong>Solicitação:</strong> #{{ solicitacao.id }} - {{ solicitacao.get_tipo_display }}</h6>
                            <p class="mb-1 small"><strong>Equipe:</strong> {{ solicitacao.equipe_delegada.nome|default:"N/D" }}</p>
                             <div class="d-flex justify-content-between card-footer-text mt-2 pt-2 border-top">
                                <span>Por: {{ solicitacao.cidadao.username }}</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                 {% if not areas_em_execucao and not solicitacoes_em_execucao %}
                    <p class="text-center text-muted small p-3">Nenhuma tarefa aqui.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {% comment %} COLUNA CONCLUÍDO {% endcomment %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingConcluido">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConcluido" aria-expanded="false" aria-controls="collapseConcluido">
                <span class="badge bg-success me-2">{{ count_concluido }}</span> Concluído
            </button>
        </h2>
        <div id="collapseConcluido" class="accordion-collapse collapse" aria-labelledby="headingConcluido" data-bs-parent="#kanbanAccordion">
            <div class="accordion-body">
                {% for area in areas_concluidas %}
                     <div class="card card-obra card-obra-area mb-3">
                        <a href="{% url 'mapa' %}?area_id={{ area.id }}" class="stretched-link"></a>
                        <div class="card-body">
                            <h6 class="card-title mb-1"><strong>Área:</strong> {{ area.nome }}</h6>
                            <p class="mb-1 small"><strong>Árvores no local:</strong> {{ area.contagem_arvores }}</p>
                            <div class="d-flex justify-content-between card-footer-text mt-2 pt-2 border-top">
                                <span>Projeto #{{ area.projeto.id }}</span>
                                <span>Finalizado em: ...</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                {% for solicitacao in solicitacoes_concluidas %}
                    <div class="card card-obra card-obra-solicitacao mb-3">
                        <a href="{% url 'solicitacao_update' pk=solicitacao.pk %}" class="stretched-link"></a>
                        <div class="card-body">
                            <h6 class="card-title mb-1"><strong>Solicitação:</strong> #{{ solicitacao.id }} - {{ solicitacao.get_tipo_display }}</h6>
                            <div class="d-flex justify-content-between card-footer-text mt-2 pt-2 border-top">
                                <span>Por: {{ solicitacao.cidadao.username }}</span>
                                <span>Finalizado em: ...</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                {% if not areas_concluidas and not solicitacoes_concluidas %}
                    <p class="text-center text-muted small p-3">Nenhuma tarefa aqui.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}