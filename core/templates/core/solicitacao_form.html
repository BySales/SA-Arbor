{% extends 'core/base_app.html' %}

{% block content %}
{% load l10n %}

<style>
    /* --- ESTILOS PARA O WIZARD (PASSO A PASSO) --- */
    .progress-bar-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        position: relative;
    }
    .progress-step {
        text-align: center;
        z-index: 1;
    }
    #map-picker {
    cursor: crosshair !important;
}

/* (Opcional) Se quiser que a m√£ozinha s√≥ apare√ßa quando estiver ARRASTANDO o mapa */
.leaflet-dragging .leaflet-grab {
    cursor: grabbing !important;
}
    .progress-step .step-circle {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #6c757d;
        border: 3px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto .5rem;
        font-weight: 700;
        transition: all .3s ease;
    }
    .progress-step .step-label {
        font-size: .85rem;
        color: #6c757d;
        transition: all .3s ease;
    }
    .progress-step.active .step-circle {
        background-color: #fff;
        border-color: #1E5943;
        color: #1E5943;
    }
    .progress-step.active .step-label {
        color: #1E5943;
        font-weight: 700;
    }
    .progress-line {
        position: absolute;
        top: 15px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: #e9ecef;
        z-index: 0;
    }
    .progress-line-fill {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: #1E5943;
        width: 0%;
        transition: width .3s ease;
    }
    .form-step {
        display: none;
    }
    .form-step.active {
        display: block;
    }

    /* --- OUTROS AJUSTES VISUAIS --- */
    .map-container-form {
        height: 275px;
        width: 100%;
        border-radius: 8px;
        z-index: 1;
    }
    #image-carousel-preview .carousel-item img {
        height: 140px;
    }
    .force-hide {
        display: none !important;
    }
    .invalid-feedback.d-block {
        display: block !important;
        width: 100%;
        margin-top: .25rem;
        font-size: .875em;
        color: #dc3545;
    }
    /* Trava redimensionamento de textareas */
    #id_descricao, #id_motivo_recusa {
        resize: none;
    }
    /* Esconde a op√ß√£o vazia "Selecione..." da lista ap√≥s abrir */
    select option[value=""] {
        display: none;
    }
    /* Estrelinha vermelha para campos obrigat√≥rios */
    .required-label::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }
</style>

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        {% if form.instance.pk %}Editar Solicita√ß√£o #{{ form.instance.id }}{% else %}Criar Nova Solicita√ß√£o{% endif %}
    </h2>
    <a href="{% url 'solicitacao_list' %}" class="btn btn-secondary-custom"><i class="bi bi-arrow-left me-1"></i> Voltar para a Lista</a>
</div>

<form method="POST" enctype="multipart/form-data" id="solicitacao-form" action="{% if form.instance.pk %}{% url 'solicitacao_update' form.instance.pk %}{% else %}{% url 'solicitacao_create' %}{% endif %}">
    {% csrf_token %}
    <input type="hidden" name="latitude" id="id_latitude" value="{{ form.latitude.value|default:'' }}">
    <input type="hidden" name="longitude" id="id_longitude" value="{{ form.longitude.value|default:'' }}">

    <div class="card">
        <div class="card-body p-4">

            <div class="progress-bar-container">
                <div class="progress-line"><div class="progress-line-fill" id="progress-line-fill"></div></div>
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Detalhes & Gest√£o</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Local e M√≠dia</div>
                </div>
            </div>

            <div class="form-step active" id="step-1">
                <h5 class="form-section-title">Detalhes da Solicita√ß√£o</h5>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-label" for="id_cidade">{{ form.cidade.label }}</label>
                            {{ form.cidade }}
                            {% if form.cidade.errors %}
                                <div class="invalid-feedback d-block">{{ form.cidade.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-label" for="id_tipo">{{ form.tipo.label }}</label>
                            {{ form.tipo }}
                            {% if form.tipo.errors %}
                                <div class="invalid-feedback d-block">{{ form.tipo.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4" id="categoria-wrapper" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label required-label" for="id_categoria">{{ form.categoria.label }}</label>
                            {{ form.categoria }}
                            {% if form.categoria.errors %}
                                <div class="invalid-feedback d-block">{{ form.categoria.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label required-label" for="id_descricao">{{ form.descricao.label }}</label>
                            {{ form.descricao }}
                            <div id="char-counter" class="form-text text-end mt-1">0 / 1000</div>
                            {% if form.descricao.errors %}
                                <div class="invalid-feedback d-block">{{ form.descricao.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    </div>

                    {% if user.is_staff or user.is_superuser %}
                    <div class="col-md-4">
                        
                        <div class="mb-3">
                            <label class="form-label text-success fw-bold required-label" for="id_status">{{ form.status.label }} (Admin)</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">{{ form.status.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3" id="equipe-wrapper" style="display: none;">
                            <label class="form-label text-success fw-bold" for="id_equipe_delegada">{{ form.equipe_delegada.label }} (Admin)</label>
                            {{ form.equipe_delegada }}
                            {% if form.equipe_delegada.errors %}
                                <div class="invalid-feedback d-block">{{ form.equipe_delegada.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3" id="bloco_especie_plantada" style="display: none;">
                            <label class="form-label text-success fw-bold required-label" for="{{ form.especie_plantada.id_for_label }}">
                                {{ form.especie_plantada.label }} (Admin)
                            </label>
                            {{ form.especie_plantada }}
                            {% if form.especie_plantada.errors %}
                                <div class="invalid-feedback d-block">{{ form.especie_plantada.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3" id="motivo-recusa-wrapper" style="display: none;">
                            <label class="form-label text-danger fw-bold required-label" for="id_motivo_recusa">{{ form.motivo_recusa.label }} (Admin)</label>
                            {{ form.motivo_recusa }}
                            {% if form.motivo_recusa.errors %}
                                <div class="invalid-feedback d-block">{{ form.motivo_recusa.errors|striptags }}</div>
                            {% endif %}
                        </div>

                    </div>
                    {% endif %}
                    </div> {% if form.non_field_errors %}
                    <div class="alert alert-danger p-2 small">{{ form.non_field_errors|striptags }}</div>
                {% endif %}

            </div> <div class="form-step" id="step-2">
                <div class="row justify-content-center">
                    <div class="col-lg-5">
                        <h5 class="form-section-title">Anexar Imagens</h5>
                        <div class="custom-file-upload">
                            <i class="bi bi-cloud-arrow-up-fill"></i>
                            <span id="upload-box-text">Clique para selecionar ou arraste as imagens aqui</span>
                            <input type="file" name="imagens" multiple id="id_imagens" class="d-none">
                        </div>
                        <div class="form-text">Voc√™ pode adicionar at√© 10 imagens.</div>
                        {% if form.imagens.errors %}
                            <div class="invalid-feedback d-block">{{ form.imagens.errors|striptags }}</div>
                        {% endif %}
                        
                        <div id="image-carousel-preview" class="carousel slide mt-3" data-bs-interval="false">
                            <div class="carousel-indicators"></div>
                            <div class="carousel-inner"></div>
                            <button class="carousel-control-prev" type="button" id="carousel-prev-btn">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" id="carousel-next-btn">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    </div>

                    <div class="col-lg-1 d-none d-lg-block"></div> <div class="col-lg-5">
                        <h5 class="form-section-title">Marcar Localiza√ß√£o</h5>
                        <div id="map-picker" class="map-container-form"></div>
                        <div id="coords-display-text" class="form-text mt-2">Clique no mapa para marcar a localiza√ß√£o exata.</div>
                        {% if form.latitude.errors %}
                            <div class="invalid-feedback d-block">{{ form.latitude.errors|striptags }}</div>
                        {% endif %}
                        {% if form.longitude.errors %}
                            <div class="invalid-feedback d-block">{{ form.longitude.errors|striptags }}</div>
                        {% endif %}
                    </div>
                </div>
                {% if form.non_field_errors %}
                    <div class="alert alert-danger p-2 small mt-3">{{ form.non_field_errors|striptags }}</div>
                {% endif %}
            </div>

        </div> <div class="card-footer d-flex justify-content-between align-items-center border-top-0 pt-4">
            <div>
                {% if form.instance.pk %}
                    <a href="{% url 'solicitacao_delete' pk=form.instance.pk %}" class="btn btn-danger-outline"><i class="bi bi-trash-fill me-1"></i> Deletar</a>
                {% endif %}
            </div>
            <div>
                <button type="button" class="btn btn-secondary-custom" id="prev-btn"><i class="bi bi-arrow-left me-1"></i> Anterior</button>
                <button type="button" class="btn btn-principal-acao" id="next-btn">Pr√≥ximo <i class="bi bi-arrow-right ms-1"></i></button>
                <button type="submit" class="btn btn-principal-acao" id="submit-button"><i class="bi bi-check-circle-fill me-1"></i><span>Salvar Solicita√ß√£o</span></button>
            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // ======================================================
    // 1. VARI√ÅVEIS GERAIS
    // ======================================================
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-button');
    const formSteps = document.querySelectorAll('.form-step');
    const progressSteps = document.querySelectorAll('.progress-step');
    const progressLineFill = document.getElementById('progress-line-fill');
    const solicitacaoForm = document.getElementById('solicitacao-form');

    const latInput = document.getElementById('id_latitude');
    const lonInput = document.getElementById('id_longitude');
    const descTextarea = document.getElementById('id_descricao');
    const charCounter = document.getElementById('char-counter');

    let currentStep = 1;
    const totalSteps = 2;
    const maxLength = 1000;

    // ======================================================
    // 2. L√ìGICA DO WIZARD (NAVEGA√á√ÉO ENTRE ETAPAS)
    // ======================================================
    function updateFormSteps() {
        formSteps.forEach(step => {
            const stepNumber = parseInt(step.id.replace('step-', ''));
            step.classList.toggle('active', stepNumber === currentStep);
        });
        progressSteps.forEach((step, index) => {
            step.classList.toggle('active', (index + 1) <= currentStep);
        });

        const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
        if (progressLineFill) progressLineFill.style.width = `${progressPercentage}%`;

        if (prevBtn) prevBtn.classList.toggle('force-hide', currentStep === 1);
        if (nextBtn) nextBtn.classList.toggle('force-hide', currentStep === totalSteps);
        if (submitBtn) submitBtn.classList.toggle('force-hide', currentStep !== totalSteps);
    }

    function validateStep(step) {
        if (step === 1) {
            // Valida√ß√£o da Categoria (se estiver vis√≠vel)
            const categoriaSelect = document.getElementById('id_categoria');
            const categoriaWrapper = document.getElementById('categoria-wrapper');
            if (categoriaSelect && categoriaWrapper && categoriaWrapper.style.display !== 'none' && categoriaSelect.value === '') {
                alert('Por favor, selecione um detalhe para sua solicita√ß√£o.');
                categoriaSelect.focus();
                return false;
            }
            // Valida√ß√£o da Descri√ß√£o
            if (descTextarea && descTextarea.value.trim() === '') {
                alert('Por favor, preencha a descri√ß√£o da solicita√ß√£o.');
                descTextarea.focus();
                return false;
            }
        }
        if (step === 2) {
            // Valida√ß√£o do Mapa
            if (latInput && latInput.value.trim() === '') {
                alert('Por favor, marque a localiza√ß√£o no mapa.');
                return false;
            }
        }
        return true;
    }

    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            if (validateStep(currentStep) && currentStep < totalSteps) {
                currentStep++;
                updateFormSteps();
                // Corrige o tamanho do mapa ao mudar de aba
                if (currentStep === 2) {
                    setTimeout(() => { 
    if(typeof map !== 'undefined' && map) {
        map.invalidateSize();
        // Se tiver a camada da cidade, garante que ela t√° enquadrada depois de redimensionar
        if (cityLayer && (!latInput.value || !lonInput.value)) {
             map.fitBounds(cityLayer.getBounds());
        }
    }
}, 100); // Aumentei pra 300ms
                }
            }
        });
    }

    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep--;
                updateFormSteps();
            }
        });
    }

    // ======================================================
    // 3. L√ìGICA "PENTE FINO" (TIPO -> CATEGORIA)
    // ======================================================
    const tipoSelect = document.getElementById('id_tipo');
    const categoriaSelect = document.getElementById('id_categoria');
    const categoriaWrapper = document.getElementById('categoria-wrapper');

    if (tipoSelect && categoriaSelect && categoriaWrapper) {
        const opcoesCategorias = {
            'SUGESTAO': [
                {valor: 'PLANTIO', texto: 'Plantio de Muda'},
                {valor: 'TROCA_LOCAL', texto: 'Troca de Local'},
                {valor: 'JARDINAGEM', texto: 'Manuten√ß√£o de Jardim/Canteiro'},
                {valor: 'EDUCACAO', texto: 'A√ß√£o Educativa'},
                {valor: 'OUTRO', texto: 'Outra Sugest√£o'}
            ],
            'DENUNCIA': [
                {valor: 'RISCO_QUEDA', texto: 'Risco de Queda (Urgente)'},
                {valor: 'PODA_IRREGULAR', texto: 'Poda Dr√°stica/Irregular'},
                {valor: 'CORTE_ILEGAL', texto: 'Corte Ilegal'},
                {valor: 'PRAGAS', texto: 'Pragas ou Doen√ßas'},
                {valor: 'MAUS_TRATOS', texto: 'Maus Tratos/Danos √† √Årvore'},
                {valor: 'OUTRO', texto: 'Outra Den√∫ncia'}
            ]
        };

        function atualizarCategorias() {
            const tipoSelecionado = tipoSelect.value;
            const categoriaAtual = "{{ form.instance.categoria|default:'' }}";
            const valorSelecionadoPeloUsuario = categoriaSelect.value;

            categoriaSelect.innerHTML = '<option value="">Selecione um detalhe...</option>';

            if (tipoSelecionado && opcoesCategorias[tipoSelecionado]) {
                categoriaWrapper.style.display = 'block';
                opcoesCategorias[tipoSelecionado].forEach(opcao => {
                    const optionElement = document.createElement('option');
                    optionElement.value = opcao.valor;
                    optionElement.textContent = opcao.texto;
                    // Mant√©m selecionado se for edi√ß√£o ou se o usu√°rio j√° escolheu
                    if (opcao.valor === valorSelecionadoPeloUsuario || (opcao.valor === categoriaAtual && !valorSelecionadoPeloUsuario)) {
                        optionElement.selected = true;
                    }
                    categoriaSelect.appendChild(optionElement);
                });
            } else {
                categoriaWrapper.style.display = 'none';
            }

            // Sempre que mudar a categoria, chama a valida√ß√£o do admin tamb√©m
            if (typeof window.toggleAdminFields === 'function') {
                window.toggleAdminFields();
            }
        }

        tipoSelect.addEventListener('change', atualizarCategorias);
        categoriaSelect.addEventListener('change', function() {
             if (typeof window.toggleAdminFields === 'function') {
                window.toggleAdminFields();
            }
        });
        atualizarCategorias(); // Roda no in√≠cio
    }

    // ======================================================
    // 4. L√ìGICA ADMIN (MOSTRAR/ESCONDER CAMPOS)
    // ======================================================
    {% if user.is_staff or user.is_superuser %}
    const statusSelect = document.getElementById('id_status');
    const equipeWrapper = document.getElementById('equipe-wrapper');
    const especieWrapper = document.getElementById('bloco_especie_plantada');
    const motivoRecusaWrapper = document.getElementById('motivo-recusa-wrapper');

    if (statusSelect && equipeWrapper && especieWrapper && motivoRecusaWrapper) {
        // Fun√ß√£o global para poder ser chamada pelo 'atualizarCategorias'
        window.toggleAdminFields = function() {
            const status = statusSelect.value;
            // Tenta pegar o valor da categoria, se o campo existir
            const categoria = categoriaSelect ? categoriaSelect.value : '';

            // 4.1. Equipe: s√≥ se estiver EM ANDAMENTO
            equipeWrapper.style.display = (status === 'EM_ANDAMENTO') ? 'block' : 'none';

            // 4.2. Esp√©cie: s√≥ se FINALIZADO **E** for PLANTIO ou TROCA
            const precisaEspecie = (status === 'FINALIZADO' && (categoria === 'PLANTIO' || categoria === 'TROCA_LOCAL'));
            especieWrapper.style.display = precisaEspecie ? 'block' : 'none';

            // 4.3. Motivo Recusa: s√≥ se RECUSADO
            motivoRecusaWrapper.style.display = (status === 'RECUSADO') ? 'block' : 'none';
        }

        statusSelect.addEventListener('change', window.toggleAdminFields);
        // A chamada inicial j√° √© feita pelo atualizarCategorias()
    }
    {% endif %}

    // ======================================================
    // 5. UPLOAD DE IMAGEM & CARROSSEL
    // ======================================================
    const imageInput = document.getElementById('id_imagens');
    const uploadBox = imageInput ? imageInput.closest('.custom-file-upload') : null;
    const carousel = document.getElementById('image-carousel-preview');
    const carouselInner = carousel ? carousel.querySelector('.carousel-inner') : null;
    const carouselIndicators = carousel ? carousel.querySelector('.carousel-indicators') : null;
    const uploadBoxText = document.getElementById('upload-box-text');
    const prevCarouselBtn = document.getElementById('carousel-prev-btn');
    const nextCarouselBtn = document.getElementById('carousel-next-btn');
    let fileList = [];

    async function updateCarousel() {
        if (!carousel || !carouselInner || !carouselIndicators || !uploadBoxText) return;

        const showButtons = fileList.length > 1;
        carousel.classList.toggle('d-none', fileList.length === 0);
        if (prevCarouselBtn && nextCarouselBtn) {
             prevCarouselBtn.style.setProperty('display', showButtons ? 'flex' : 'none', showButtons ? '' : 'important');
             nextCarouselBtn.style.setProperty('display', showButtons ? 'flex' : 'none', showButtons ? '' : 'important');
        }

        if (fileList.length === 0) {
            uploadBoxText.innerHTML = 'Clique para selecionar ou arraste as imagens aqui';
        } else {
            const plural = fileList.length > 1 ? 's' : '';
            uploadBoxText.innerHTML = `<strong>${fileList.length} imagem${plural} selecionada${plural}</strong><br><small>Clique ou arraste para adicionar mais</small>`;
        }

        const previews = await Promise.all(fileList.map(file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        })));

        let innerHTML = '';
        let indicatorsHTML = '';
        previews.forEach((previewSrc, index) => {
            const file = fileList[index];
            innerHTML += `<div class="carousel-item ${index === 0 ? 'active' : ''}"><img src="${previewSrc}" class="d-block w-100" alt="Pr√©via"><button type="button" class="delete-image-btn" data-file-id="${file.uniqueId}"><i class="bi bi-trash-fill"></i></button></div>`;
            indicatorsHTML += `<button type="button" data-bs-target="#image-carousel-preview" data-bs-slide-to="${index}" class="${index === 0 ? 'active' : ''}"></button>`;
        });
        carouselInner.innerHTML = innerHTML;
        carouselIndicators.innerHTML = indicatorsHTML;
    }

    if (uploadBox && imageInput) {
        uploadBox.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', (e) => {
            const newFiles = Array.from(e.target.files);
            if (fileList.length + newFiles.length > 10) {
                alert(`M√°ximo de 10 imagens permitido.`);
                e.target.value = '';
                return;
            }
            newFiles.forEach(f => { f.uniqueId = Date.now() + Math.random(); fileList.push(f); });
            e.target.value = '';
            updateCarousel();
        });
    }
    if (carousel) {
        carousel.addEventListener('click', (e) => {
            const btn = e.target.closest('.delete-image-btn');
            if (btn) {
                fileList = fileList.filter(f => f.uniqueId !== parseFloat(btn.dataset.fileId));
                updateCarousel();
            }
        });
    }
    // Scroll dos bot√µes do carrossel
    if (prevCarouselBtn && carouselInner) {
        prevCarouselBtn.addEventListener('click', () => {
             const item = carouselInner.querySelector('.carousel-item');
             if(item) carouselInner.scrollBy({ left: -(item.offsetWidth + 15), behavior: 'smooth' });
        });
    }
    if (nextCarouselBtn && carouselInner) {
        nextCarouselBtn.addEventListener('click', () => {
             const item = carouselInner.querySelector('.carousel-item');
             if(item) carouselInner.scrollBy({ left: (item.offsetWidth + 15), behavior: 'smooth' });
        });
    }


// ======================================================
    // 6. MAPA LEAFLET (TURBINADO üöÄ)
    // ======================================================
    let map = null;
    let marker = null;
    let cityLayer = null; // Camada pra desenhar o limite da cidade
    let cidadesGeoData = {}; // Vai guardar os GeoJSONs das cidades

    const mapContainer = document.getElementById('map-picker');
    const coordsDisplayText = document.getElementById('coords-display-text');
    const cidadeSelect = document.getElementById('id_cidade'); // Precisa desse elemento

    if (mapContainer && latInput && lonInput) {
        map = L.map('map-picker', { zoomControl: false }).setView([-24.0965, -46.6212], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map); // Bota o zoom embaixo na direita

        // --- 6.1. BUSCA POR ENDERE√áO ---
        if (L.Control.Geocoder) {
            L.Control.geocoder({
                defaultMarkGeocode: false,
                position: 'topleft',
                placeholder: 'Buscar endere√ßo...',
                errorMessage: 'Endere√ßo n√£o encontrado.'
            })
            .on('markgeocode', function(e) {
                const bbox = e.geocode.bbox;
                const poly = L.polygon([
                    bbox.getSouthEast(),
                    bbox.getNorthEast(),
                    bbox.getNorthWest(),
                    bbox.getSouthWest()
                ]);
                map.fitBounds(poly.getBounds());
            })
            .addTo(map);
        }

        // --- 6.2. BOT√ÉO DE GPS ---
        const gpsControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                container.innerHTML = '<a href="#" title="Minha Localiza√ß√£o" role="button" style="width: 30px; height: 30px; line-height: 30px; text-align: center; font-size: 18px; display: block; background: white;"><i class="bi bi-crosshair"></i></a>';
                container.onclick = function(e) {
                    e.preventDefault();
                    if (navigator.geolocation) {
                         map.locate({setView: true, maxZoom: 16});
                    } else {
                        alert("Geolocaliza√ß√£o n√£o suportada pelo seu navegador.");
                    }
                    return false;
                }
                return container;
            }
        });
        map.addControl(new gpsControl());
        // Escuta quando o mapa acha a localiza√ß√£o
        map.on('locationfound', function(e) {
             if (marker) marker.setLatLng(e.latlng);
             else marker = L.marker(e.latlng).addTo(map);
             latInput.value = e.latlng.lat.toFixed(6);
             lonInput.value = e.latlng.lng.toFixed(6);
             updateCoords(e.latlng.lat, e.latlng.lng);
        });
        map.on('locationerror', function(e) { alert(e.message); });


        function updateCoords(lat, lon) {
            if (coordsDisplayText) coordsDisplayText.innerHTML = `<strong>Local:</strong> Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
        }

        // --- 6.3. DESENHAR LIMITE DA CIDADE ---
        // Primeiro, busca os dados das cidades na API
        fetch('/api/cidades-geo/')
            .then(r => r.json())
            .then(data => {
                if (data.cidades) {
                    data.cidades.forEach(c => {
                        cidadesGeoData[c.nome] = c.geom; 
                    });
                    // üî• A CORRE√á√ÉO T√Å AQUI:
                    // Assim que os dados chegam, a gente for√ßa a atualiza√ß√£o do mapa
                    // pra ele pegar a cidade que j√° veio selecionada no form.
                    atualizarMapaCidade();
                }
            })
            .catch(err => console.error("Erro ao carregar cidades:", err));

            function atualizarMapaCidade() {
            // Garante que tudo que a gente precisa existe antes de tentar usar
            if (!cidadeSelect || !map || Object.keys(cidadesGeoData).length === 0) return;
            
            const cidadeNome = cidadeSelect.options[cidadeSelect.selectedIndex].text;
            
            // Se por acaso o texto for "Selecione a cidade...", a gente ignora
            if (cidadeNome === "Selecione a cidade...") return;

            const geom = cidadesGeoData[cidadeNome];

            if (geom) {
                if (cityLayer) map.removeLayer(cityLayer); 
                
                cityLayer = L.geoJSON(geom, {
                    style: { color: '#1E5943', weight: 2, fillOpacity: 0.1 },
                    interactive: false
                }).addTo(map);
                
                // S√≥ d√° zoom na cidade se N√ÉO tiver um pino j√° marcado (pra n√£o tirar o foco do usu√°rio se ele estiver editando)
                if (!latInput.value || !lonInput.value) {
                     map.fitBounds(cityLayer.getBounds());
                }
                // üî• FOR√áA O REDESENHO DO MAPA (CORRIGE O MAPA CINZA)
                map.invalidateSize();
            }
        }

        // Escuta quando o usu√°rio muda a cidade na Etapa 1
        if (cidadeSelect) {
            cidadeSelect.addEventListener('change', atualizarMapaCidade);
        }

        if (latInput.value && lonInput.value) {
            try {
                const lat = parseFloat(latInput.value.replace(',', '.'));
                const lon = parseFloat(lonInput.value.replace(',', '.'));
                if (!isNaN(lat) && !isNaN(lon)) {
                    const latlng = [lat, lon];
                    map.setView(latlng, 18);
                    marker = L.marker(latlng).addTo(map);
                    updateCoords(lat, lon);
                }
            } catch (e) { console.error(e); }
        }

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            latInput.value = lat.toFixed(6);
            lonInput.value = lng.toFixed(6);
            if (marker) marker.setLatLng(e.latlng);
            else marker = L.marker(e.latlng).addTo(map);
            updateCoords(lat, lng);
        });
    }

    // ======================================================
    // 7. CONTADOR DE CARACTERES
    // ======================================================
    if (descTextarea && charCounter) {
        const updateCharCounter = () => {
            const len = descTextarea.value.length;
            charCounter.innerHTML = `${len} / ${maxLength}`;
            charCounter.classList.toggle('text-danger', len > maxLength);
            charCounter.classList.toggle('fw-bold', len > maxLength);
        };
        descTextarea.addEventListener('input', updateCharCounter);
        updateCharCounter(); // Inicializa
    }

    // ======================================================
    // 8. SUBMIT DO FORMUL√ÅRIO (AJAX)
    // ======================================================
    const submitButton = document.getElementById('submit-button');
    const submitIcon = submitButton ? submitButton.querySelector('.bi') : null;
    const submitText = submitButton ? submitButton.querySelector('span') : null;

    if (solicitacaoForm && submitButton) {
        solicitacaoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitButton.disabled = true;
            if (submitIcon) {
                submitIcon.classList.remove('bi-check-circle-fill');
                submitIcon.classList.add('bi-arrow-repeat', 'spinner-icon');
            }
            if (submitText) submitText.textContent = 'Salvando...';

            const formData = new FormData(solicitacaoForm);
            // Adiciona imagens manualmente porque elas n√£o est√£o no input original
            fileList.forEach(file => formData.append('imagens', file));

            fetch(solicitacaoForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(r => r.json().then(data => ({ ok: r.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    let msg = 'Erro desconhecido.';
                    if (data.errors) {
                        msg = '';
                        for (const [field, errors] of Object.entries(data.errors)) {
                            // Tenta achar o label leg√≠vel do campo
                            let label = field;
                            if (field !== '__all__') {
                                const labelEl = document.querySelector(`label[for="id_${field}"]`);
                                if (labelEl) label = labelEl.textContent.replace('(Admin)', '').replace('*', '').trim();
                            }
                            msg += `${label !== field ? label + ': ' : ''}${errors.join(', ')}\n`;
                        }
                    }
                    alert('Erro ao salvar:\n\n' + msg);
                }
            })
            .catch(() => alert('Erro de conex√£o.'))
            .finally(() => {
                submitButton.disabled = false;
                if (submitIcon) {
                    submitIcon.classList.add('bi-check-circle-fill');
                    submitIcon.classList.remove('bi-arrow-repeat', 'spinner-icon');
                }
                if (submitText) submitText.textContent = 'Salvar Solicita√ß√£o';
            });
        });
    }

    // Inicializa tudo
    updateFormSteps();
    updateCarousel();
});
</script>
{% endblock %}