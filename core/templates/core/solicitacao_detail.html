{% extends 'core/base_app.html' %}

{% block content %}
<style>
    /* Estilo rápido pra destacar os blocos de retorno */
    .feedback-box {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .btn-outline-principal {
        color: #1E5943;
        border-color: #1E5943;
    }
    .btn-outline-principal:hover {
        background-color: #1E5943;
        color: white;
    }
    .feedback-recusa { background-color: #ffecec; border-left: 4px solid #dc3545; color: #842029; }
    .feedback-sucesso { background-color: #e8f5e9; border-left: 4px solid #198754; color: #0f5132; }
    
    /* Ajuste pro mapa na tela de detalhes */
    .map-container-form { height: 300px; width: 100%; border-radius: 8px; }

    /* Sua galeria (mantida caso você tenha CSS global pra ela, se não tiver, avisa que eu passo) */
    .image-gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .gallery-item { position: relative; height: 100px; border-radius: 8px; overflow: hidden; }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    .view-icon { position: absolute; inset: 0; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .gallery-item:hover .view-icon { opacity: 1; }
</style>

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <h2 class="mb-0 me-3">Solicitação #{{ solicitacao.id }}</h2>
        <span class="badge status-badge-lg status-{{ solicitacao.status|lower }}" style="font-size: 1rem; padding: 0.5em 0.8em;">
            {{ solicitacao.get_status_display }}
        </span>
    </div>
    <div>
        <a href="{% url 'solicitacao_list' %}" class="btn btn-secondary-custom me-2">
            <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
        {% if user.is_staff or user == solicitacao.cidadao %}
        <a href="{% url 'solicitacao_update' pk=solicitacao.pk %}" class="btn btn-principal-acao">
            <i class="bi bi-pencil-fill me-1"></i> Editar
        </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-body p-4">
                <h5 class="form-section-title">Informações Gerais</h5>
                <dl class="row">
                    <dt class="col-sm-4">Cidade:</dt>
                    <dd class="col-sm-8">{{ solicitacao.cidade.nome }}</dd>

                    <dt class="col-sm-4">Tipo:</dt>
                    <dd class="col-sm-8">
                        {% if solicitacao.tipo == 'DENUNCIA' %}
                            <span class="tag tag-denuncia">Denúncia</span>
                        {% else %}
                            <span class="tag tag-sugestao">Sugestão</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-4">Detalhe:</dt>
                    <dd class="col-sm-8">{{ solicitacao.get_categoria_display|default:"-" }}</dd>

                    <dt class="col-sm-4">Aberto por:</dt>
                    <dd class="col-sm-8">{{ solicitacao.cidadao.first_name|default:solicitacao.cidadao.username }}</dd>

                    <dt class="col-sm-4">Data de Criação:</dt>
                    <dd class="col-sm-8">{{ solicitacao.data_criacao|date:"d/m/Y \à\s H:i" }}</dd>
                    
                    {% if solicitacao.data_finalizacao %}
                    <dt class="col-sm-4">Finalizado em:</dt>
                    <dd class="col-sm-8">{{ solicitacao.data_finalizacao|date:"d/m/Y \à\s H:i" }}</dd>
                    {% endif %}
                </dl>

                <h5 class="form-section-title mt-4">Descrição</h5>
                <div class="bg-light p-3 rounded">
                    {{ solicitacao.descricao|linebreaks }}
                </div>

                {% if solicitacao.motivo_recusa or solicitacao.especie_plantada %}
                <h5 class="form-section-title mt-4">Retorno da Solicitação</h5>
                
                    {% if solicitacao.motivo_recusa %}
                    <div class="feedback-box feedback-recusa">
                        <strong><i class="bi bi-x-circle-fill me-2"></i>Motivo da Recusa:</strong><br>
                        {{ solicitacao.motivo_recusa|linebreaksbr }}
                    </div>
                    {% endif %}

                    {% if solicitacao.especie_plantada %}
                    <div class="feedback-box feedback-sucesso">
                        <strong><i class="bi bi-check-circle-fill me-2"></i>Serviço Realizado:</strong><br>
                        Foi plantada uma muda de <strong>{{ solicitacao.especie_plantada.nome_popular }}</strong> neste local.
                    </div>
                    {% endif %}
                {% endif %}

                {% if solicitacao.imagens.all %}
                <div class="mt-4">
                    <h5 class="form-section-title">Imagens ({{ solicitacao.imagens.count }})</h5>
                    <div class="image-gallery-grid">
                        {% for imagem_obj in solicitacao.imagens.all %}
                            <div class="gallery-item">
                                <img src="{{ imagem_obj.imagem.url }}" alt="Imagem da Solicitação">
                                <a href="{{ imagem_obj.imagem.url }}" target="_blank" class="view-icon" title="Ver imagem original">
                                    <i class="bi bi-eye-fill fs-3"></i>
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {% if user.is_staff %}
        <div class="card bg-light border-0">
            <div class="card-body">
                <h6 class="fw-bold text-muted mb-3"><i class="bi bi-shield-lock me-1"></i>Dados Internos (Admin)</h6>
                <dl class="row mb-0">
                    <dt class="col-sm-4">Equipe Delegada:</dt>
                    <dd class="col-sm-8">
                        {% if solicitacao.equipe_delegada %}
                            <span class="badge bg-primary">{{ solicitacao.equipe_delegada.nome }}</span>
                        {% else %}
                            <span class="text-muted fst-italic">Nenhuma equipe delegada</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px; z-index: 0;"> 
            <div class="card-body p-3">
                <h5 class="form-section-title mb-3">Localização da Solicitação</h5>
                <div id="map-viewer" class="map-container-form"></div>
                
                {% if solicitacao.latitude and solicitacao.longitude %}
                <div class="mt-3 text-center">
                    <a href="https://www.google.com/maps/search/?api=1&query={{ solicitacao.latitude|stringformat:'f' }},{{ solicitacao.longitude|stringformat:'f' }}" target="_blank" class="btn btn-outline-principal w-100">
                        <i class="bi bi-geo-alt-fill me-1"></i> Abrir no Google Maps
                    </a>
                </div>
                {% endif %}

                <div class="mt-3 pt-3 border-top">
                    {% if user != solicitacao.cidadao %}
                        <p class="text-muted small">
                            Seja avisado sobre qualquer mudança nesta solicitação.
                        </p>
                        
                        <button id="btn-interesse" 
                                class="btn {% if user in solicitacao.interessados.all %}btn-outline-danger{% else %}btn-outline-principal{% endif %} w-100" 
                                data-url="{% url 'toggle_interesse_api' solicitacao.pk %}">
                            
                            {% if user in solicitacao.interessados.all %}
                                <i class="bi bi-bell-slash-fill me-1"></i> Deixar de seguir
                            {% else %}
                                <i class="bi bi-bell-fill me-1"></i> Tenho Interesse (Seguir)
                            {% endif %}
                        </button>

                    {% else %}
                        <p class="text-muted small">
                            <i class="bi bi-info-circle-fill me-1"></i> Você é o autor desta solicitação e já receberá todas as notificações.
                        </p>
                    {% endif %}

                    <div class="mt-2 text-center text-muted small" id="contador-interesse-container">
                        <span id="contador-interesse">{{ solicitacao.interessados.count }}</span> 
                        outra{% if solicitacao.interessados.count != 1 %}s{% endif %} 
                        pessoa{% if solicitacao.interessados.count != 1 %}s{% endif %} 
                        {% if solicitacao.interessados.count == 1 %}está interessada.{% else %}estão interessadas.{% endif %}
                    </div>
                </div>
                </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. LÓGICA DO MAPA (O TEU CÓDIGO ORIGINAL) ---
    {% if solicitacao.latitude and solicitacao.longitude %}
        const lat = {{ solicitacao.latitude|stringformat:"f" }};
        const lon = {{ solicitacao.longitude|stringformat:"f" }};
        const map = L.map('map-viewer', {
            zoomControl: false, dragging: false, scrollWheelZoom: false,
            doubleClickZoom: false, touchZoom: false
        }).setView([lat, lon], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);
        
        L.marker([lat, lon]).addTo(map);

    {% else %}
        document.getElementById('map-viewer').innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted rounded border">Sem localização marcada.</div>';
    {% endif %}


    // --- 2. LÓGICA DO BOTÃO DE INTERESSE (O NOSSO "MOTOR") ---
    const btnInteresse = document.getElementById('btn-interesse');
    
    if (btnInteresse) {
        btnInteresse.addEventListener('click', function() {
            const url = this.dataset.url;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const contadorContainer = document.getElementById('contador-interesse-container');
                    const novoCount = data.count;

                    // Atualiza o contador
                    if (novoCount === 0) {
                        contadorContainer.innerHTML = '<span id="contador-interesse">0</span> outras pessoas estão interessadas.';
                    } else if (novoCount === 1) {
                        contadorContainer.innerHTML = '<span id="contador-interesse">1</span> outra pessoa está interessada.';
                    } else {
                        contadorContainer.innerHTML = `<span id="contador-interesse">${novoCount}</span> outras pessoas estão interessadas.`;
                    }

                    // Troca o visual do botão
                    if (data.interessado === true) {
                        btnInteresse.innerHTML = '<i class="bi bi-bell-slash-fill me-1"></i> Deixar de seguir';
                        btnInteresse.classList.remove('btn-outline-principal');
                        btnInteresse.classList.add('btn-outline-danger');
                    } else {
                        btnInteresse.innerHTML = '<i class="bi bi-bell-fill me-1"></i> Tenho Interesse (Seguir)';
                        btnInteresse.classList.add('btn-outline-principal');
                        btnInteresse.classList.remove('btn-outline-danger');
                    }
                } else {
                    console.error('Erro na API:', data.message);
                }
            })
            .catch(error => {
                console.error('Erro no Fetch:', error);
            });
        });
    }
});
</script>
{% endblock %}