{% extends 'core/base.html' %}

{% block content %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <h2>Mapa de Gestão</h2>
    <div id="map" style="height: 600px;" class="mb-3"></div>

    {{ arvores_data|json_script:"arvores-data-json" }}
    {{ solicitacoes_data|json_script:"solicitacoes-data-json" }}
    {{ areas_data|json_script:"areas-data-json" }}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        var map = L.map('map').setView([-24.0965, -46.6212], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

        // --- DEFININDO NOSSOS TRÊS ÍCONES ---
        var treeIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });
        var alertIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });
        var suggestionIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // --- PREPARANDO AS CAMADAS ---
        var camadaArvores = L.layerGroup().addTo(map);
        var camadaSolicitacoes = L.layerGroup().addTo(map);
        var camadaAreasSalvas = L.layerGroup().addTo(map);

        // --- PROCESSANDO DADOS DAS ÁRVORES ---
        const arvoresDataElement = document.getElementById('arvores-data-json');
        const arvoresData = JSON.parse(arvoresDataElement.textContent);
        arvoresData.forEach(function(arvore) {
            if (arvore.lat && arvore.lon) {
                var marker = L.marker([arvore.lat, arvore.lon], {icon: treeIcon}).bindPopup("<b>" + arvore.nome + "</b>");
                camadaArvores.addLayer(marker);
            }
        });
        
        // --- PROCESSANDO DADOS DAS SOLICITAÇÕES (COM LÓGICA DE COR) ---
        const solicitacoesDataElement = document.getElementById('solicitacoes-data-json');
        const solicitacoesData = JSON.parse(solicitacoesDataElement.textContent);
        solicitacoesData.forEach(function(solicitacao) {
            if (solicitacao.lat && solicitacao.lon) {
                var iconeEscolhido;
                if (solicitacao.tipo_codigo === 'DENUNCIA') {
                    iconeEscolhido = alertIcon; // Vermelho para denúncias
                } else {
                    iconeEscolhido = suggestionIcon; // Amarelo para sugestões
                }
                var marker = L.marker([solicitacao.lat, solicitacao.lon], {icon: iconeEscolhido}).bindPopup("<b>" + solicitacao.tipo_display + "</b>");
                camadaSolicitacoes.addLayer(marker);
            }
        });

        // --- DESENHANDO AS ÁREAS SALVAS ---
        const areasDataElement = document.getElementById('areas-data-json');
        const areasData = JSON.parse(areasDataElement.textContent);
        areasData.forEach(function(area) {
            if (area.geom) {
                var areaLayer = L.geoJSON(area.geom).bindPopup("<b>" + area.nome + "</b>");
                camadaAreasSalvas.addLayer(areaLayer);
            }
        });

        // --- ATUALIZANDO O CONTROLE DE CAMADAS ---
        var overlayMaps = {
            "Árvores": camadaArvores,
            "Solicitações Abertas": camadaSolicitacoes,
            "Áreas Planejadas": camadaAreasSalvas
        };
        L.control.layers(null, overlayMaps).addTo(map);

        // --- CONFIGURANDO AS FERRAMENTAS DE DESENHO ---
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ edit: { featureGroup: drawnItems }, draw: { polygon: true, polyline: false, rectangle: true, circle: false, marker: true } });
        map.addControl(drawControl);
        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;
            var geojson = layer.toGeoJSON();
            drawnItems.addLayer(layer);
            fetch("{% url 'salvar_area' %}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(geojson) })
            .then(response => response.json())
            .then(data => {
                console.log('Resposta do servidor:', data);
                if (data.status === 'ok') { alert('Área salva com sucesso! Atualize a página para ver o desenho salvo.'); } 
                else { alert('Ocorreu um erro ao salvar a área: ' + data.message); }
            })
            .catch((error) => {
                console.error('Erro na requisição:', error);
                alert('Erro de comunicação com o servidor.');
            });
        });
    </script>
{% endblock %}