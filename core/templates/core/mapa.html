{% extends 'core/base.html' %}

{% block content %}
    <h2>Mapa de Gestão</h2>
    
    <div id="map-container" style="position: relative; height: 600px;" class="mb-3">
        <div id="map" style="height: 100%;"></div>
        
        <div id="custom-layer-control" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ccc; width: 250px; max-height: 90%; overflow-y: auto;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Camadas</h5>
                <button id="toggle-layers-btn" class="btn btn-sm btn-outline-secondary">-</button>
            </div>
            <hr class="my-2">
            <div id="layer-control-content">
                <h6>Dados do Sistema</h6>
                <div id="data-layers"></div>
                <hr class="my-2">
                <h6>Áreas Planejadas</h6>
                <div id="drawn-layers"></div>
            </div>
        </div>
        
        <div id="details-panel" class="d-none" style="position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; border: 1px solid #ccc; width: 250px;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 id="details-title" class="mb-0">Detalhes</h5>
                <button id="close-details-btn" type="button" class="btn-close"></button>
            </div>
            <hr class="my-2">
            <div id="details-content"></div>
        </div>
        
        <div id="coords-display" style="position: absolute; bottom: 10px; right: 10px; z-index: 1000; background: rgba(255, 255, 255, 0.8); padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-family: monospace;">
            Lat: -- | Lon: --
        </div>
    </div>

    {{ arvores_data|json_script:"arvores-data-json" }}
    {{ solicitacoes_data|json_script:"solicitacoes-data-json" }}
    {{ areas_data|json_script:"areas-data-json" }}
    {{ solicitacao_foco_id|json_script:"solicitacao-foco-id" }}

    <div class="modal fade" id="areaFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Detalhes da Área</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="area-form">
                        {{ form_area.as_p }}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="deleteAreaButton" class="btn btn-danger me-auto d-none">Excluir</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="saveAreaButton" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="instanciaFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Nova Árvore ao Mapa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="instancia-arvore-form" autocomplete="off">
                        <div class="mb-3">
                            <label for="especie-select" class="form-label">Espécie</label>
                            <select id="especie-select" class="form-select" required>
                                <option value="" disabled selected>Selecione a espécie...</option>
                                {% for especie in todas_especies %}
                                    <option value="{{ especie.id }}">{{ especie.nome_popular }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="saude-select" class="form-label">Estado de Saúde</label>
                            <select id="saude-select" class="form-select">
                                {% for value, label in opcoes_saude %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="plantio-date" class="form-label">Data de Plantio</label>
                            <input type="date" id="plantio-date" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="saveInstanciaButton" class="btn btn-primary">Salvar Árvore</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {

        function showToast(title, message, isError=false) {
            const toastEl = document.getElementById('liveToast');
            const toastTitle = document.getElementById('toast-title');
            const toastBody = document.getElementById('toast-body');

            if (!toastEl || !toastTitle || !toastBody) {
                console.error('Toast elements not found!');
                return;
            }

            toastTitle.textContent = title;
            toastBody.textContent = message;

            toastEl.classList.toggle('bg-danger', isError);
            toastEl.classList.toggle('text-white', isError);
            toastEl.classList.toggle('bg-success', !isError);
            toastEl.classList.toggle('text-dark', !isError);

            const bsToast = new bootstrap.Toast(toastEl);
            bsToast.show();
        }

        var map = L.map('map').setView([-24.0965, -46.6212], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

        var treeIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        var alertIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        var suggestionIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

        var camadaArvores = L.layerGroup().addTo(map);
        var camadaSolicitacoes = L.layerGroup().addTo(map);
        const areaLayers = {};
        const detailsPanel = document.getElementById('details-panel');
        const detailsTitle = document.getElementById('details-title');
        const detailsContent = document.getElementById('details-content');
        const closeDetailsBtn = document.getElementById('close-details-btn');
        closeDetailsBtn.addEventListener('click', function() { detailsPanel.classList.add('d-none'); });

        const arvoresData = JSON.parse(document.getElementById('arvores-data-json').textContent);
        arvoresData.forEach(function(arvore) {
            if (arvore.lat && arvore.lon) {
                var marker = L.marker([arvore.lat, arvore.lon], {icon: treeIcon});
                marker.on('click', function() {
                    const content = `
                        <p class="mb-1"><strong>Científico:</strong> ${arvore.nome_cientifico || 'N/A'}</p>
                        <p class="mb-1"><strong>Saúde:</strong> ${arvore.saude || 'N/A'}</p>
                        <p class="mb-1"><strong>Plantio:</strong> ${arvore.plantio || 'N/A'}</p>
                        <hr class="my-1">
                        <p class="mb-1">${arvore.descricao || 'Sem descrição.'}</p>
                    `;
                    detailsTitle.innerHTML = `Árvore: ${arvore.nome}`;
                    detailsContent.innerHTML = content;
                    detailsPanel.classList.remove('d-none');
                });
                camadaArvores.addLayer(marker);
            }
        });

        const solicitacaoMarkers = {};
        const solicitacoesData = JSON.parse(document.getElementById('solicitacoes-data-json').textContent);
        solicitacoesData.forEach(function(solicitacao) {
            if (solicitacao.lat && solicitacao.lon) {
                var iconeEscolhido = (solicitacao.tipo_codigo === 'DENUNCIA') ? alertIcon : suggestionIcon;
                var marker = L.marker([solicitacao.lat, solicitacao.lon], {icon: iconeEscolhido});
                marker.on('click', function() {
                    const content = `<p><strong>Status:</strong> ${solicitacao.status || 'N/A'}</p><p><strong>Descrição:</strong> ${solicitacao.descricao || 'N/A'}</p><a href="/solicitacoes/${solicitacao.id}/editar/" class="btn btn-secondary btn-sm mt-2">Ver / Editar Detalhes</a>`;
                    detailsTitle.innerHTML = `Solicitação: ${solicitacao.tipo_display}`;
                    detailsContent.innerHTML = content;
                    detailsPanel.classList.remove('d-none');
                });
                camadaSolicitacoes.addLayer(marker);
                solicitacaoMarkers[solicitacao.id] = marker;
            }
        });

        const areasData = JSON.parse(document.getElementById('areas-data-json').textContent);
        areasData.forEach(function(area) {
            if (area.geom) {
                var areaLayer = L.geoJSON(area.geom);
                areaLayer.on('click', function() {
                    openEditModal(area.id);
                });
                areaLayers[area.id] = areaLayer;
            }
        });

        const dataLayersContainer = document.getElementById('data-layers');
        const drawnLayersContainer = document.getElementById('drawn-layers');

        function toggleLayer(checkbox, layer) {
            if (checkbox.checked) {
                map.addLayer(layer);
            } else {
                map.removeLayer(layer);
            }
        }

        dataLayersContainer.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" id="arvoresCheck" checked><label class="form-check-label" for="arvoresCheck">Árvores</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="solicitacoesCheck" checked><label class="form-check-label" for="solicitacoesCheck">Solicitações</label></div>`;
        document.getElementById('arvoresCheck').addEventListener('change', function() { toggleLayer(this, camadaArvores); });
        document.getElementById('solicitacoesCheck').addEventListener('change', function() { toggleLayer(this, camadaSolicitacoes); });

        if (areasData.length > 0) {
            drawnLayersContainer.innerHTML = '';
            areasData.forEach(function(area) {
                const layerId = `area-${area.id}`;
                drawnLayersContainer.innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" id="${layerId}" checked><label class="form-check-label" for="${layerId}">${area.nome}</label></div>`;
            });
            areasData.forEach(function(area) {
                const layerId = `area-${area.id}`;
                document.getElementById(layerId).addEventListener('change', function() { toggleLayer(this, areaLayers[area.id]); });
                map.addLayer(areaLayers[area.id]);
            });
        } else {
            drawnLayersContainer.innerHTML = '<small>Nenhuma área salva.</small>';
        }

        const toggleButton = document.getElementById('toggle-layers-btn');
        const layerContent = document.getElementById('layer-control-content');
        toggleButton.addEventListener('click', function() {
            layerContent.classList.toggle('d-none');
            toggleButton.textContent = layerContent.classList.contains('d-none') ? '+' : '-';
        });

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({ edit: { featureGroup: drawnItems }, draw: { polygon: true, polyline: false, rectangle: true, circle: false, marker: true } });
        map.addControl(drawControl);

        const areaModal = new bootstrap.Modal(document.getElementById('areaFormModal'));
        const instanciaModal = new bootstrap.Modal(document.getElementById('instanciaFormModal'));
        const saveAreaButton = document.getElementById('saveAreaButton');
        const deleteAreaButton = document.getElementById('deleteAreaButton');
        const areaForm = document.getElementById('area-form');
        const modalTitle = document.getElementById('modalTitle');
        let temporaryLayer = null;
        let editingAreaId = null;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function openEditModal(areaId) {
            editingAreaId = areaId;
            temporaryLayer = null;
            modalTitle.textContent = 'Editar Detalhes da Área';
            deleteAreaButton.classList.remove('d-none');
            fetch(`/api/areas/${areaId}/`)
            .then(response => response.json())
            .then(data => {
                areaForm.elements['nome'].value = data.nome;
                areaForm.elements['tipo'].value = data.tipo;
                areaForm.elements['status'].value = data.status;
                areaModal.show();
            });
        }

        map.on(L.Draw.Event.CREATED, function (event) {
            temporaryLayer = event.layer;
            
            if (event.layerType === 'marker') {
                document.getElementById('instancia-arvore-form').reset();
                instanciaModal.show();
            } else {
                editingAreaId = null;
                areaForm.reset();
                modalTitle.textContent = 'Detalhes da Nova Área';
                deleteAreaButton.classList.add('d-none');
                areaModal.show();
            }
        });

        saveAreaButton.addEventListener('click', function() {
            const formData = new FormData(areaForm);
            const formObject = Object.fromEntries(formData.entries());
            let url, method, finalData;

            if (editingAreaId) {
                url = `/api/areas/${editingAreaId}/`;
                method = 'PUT';
                finalData = { form_data: formObject };
            } else {
                url = "{% url 'salvar_area' %}";
                method = 'POST';
                const geometryData = temporaryLayer.toGeoJSON();
                finalData = { form_data: formObject, geometry: geometryData.geometry };
            }

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify(finalData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    showToast('Sucesso!', data.message);
                    areaModal.hide();
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showToast('Erro ao Salvar', (data.message || JSON.stringify(data.errors)), true);
                }
            });
        });

        deleteAreaButton.addEventListener('click', function() {
            if (confirm('Tem certeza que quer deletar esta área?')) {
                fetch(`/api/areas/${editingAreaId}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrftoken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        showToast('Sucesso!', data.message);
                        areaModal.hide();
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showToast('Erro ao Deletar', data.message, true);
                    }
                });
            }
        });

        const saveInstanciaButton = document.getElementById('saveInstanciaButton');
        saveInstanciaButton.addEventListener('click', function() {
            const especieId = document.getElementById('especie-select').value;
            const estadoSaude = document.getElementById('saude-select').value;
            const dataPlantio = document.getElementById('plantio-date').value;
            
            if (!especieId) {
                alert('Por favor, selecione uma espécie.');
                return;
            }

            const latlng = temporaryLayer.getLatLng();

            const dataToSend = {
                especie_id: especieId,
                lat: latlng.lat,
                lon: latlng.lng,
                estado_saude: estadoSaude,
                data_plantio: dataPlantio,
            };

            fetch("{% url 'instancia_arvore_create_api' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    instanciaModal.hide();
                    showToast('Sucesso!', data.message);
                    
                    const novaArvore = data.nova_arvore;
                    var newMarker = L.marker([novaArvore.lat, novaArvore.lon], {icon: treeIcon}).addTo(camadaArvores);

                    newMarker.on('click', function() {
                        const content = `
                            <p class="mb-1"><strong>Científico:</strong> ${novaArvore.nome_cientifico || 'N/A'}</p>
                            <p class="mb-1"><strong>Saúde:</strong> ${novaArvore.saude || 'N/A'}</p>
                            <p class="mb-1"><strong>Plantio:</strong> ${novaArvore.plantio || 'N/A'}</p>
                            <hr class="my-1">
                            <p class="mb-1">${novaArvore.descricao || 'Sem descrição.'}</p>
                        `;
                        detailsTitle.innerHTML = `Árvore: ${novaArvore.nome}`;
                        detailsContent.innerHTML = content;
                        detailsPanel.classList.remove('d-none');
                    });
                } else {
                    showToast('Erro ao Salvar', data.message, true);
                }
            }).catch(error => {
                console.error("Fetch Error:", error);
                showToast('Erro de Rede', 'Não foi possível conectar ao servidor.', true);
            });
        });

        const solicitacaoFocoId = JSON.parse(document.getElementById('solicitacao-foco-id').textContent);

        if (solicitacaoFocoId) {
            const markerToFocus = solicitacaoMarkers[solicitacaoFocoId];
            if (markerToFocus) {
                const latLng = markerToFocus.getLatLng();
                map.flyTo(latLng, 18);
                markerToFocus.fire('click');
            }
        }

        var coordsDisplay = document.getElementById('coords-display');
        map.on('mousemove', function(e) {
            var lat = e.latlng.lat.toFixed(5);
            var lon = e.latlng.lng.toFixed(5);
            coordsDisplay.innerHTML = `Lat: ${lat} | Lon: ${lon}`;
        });
        map.on('mouseout', function(e) { coordsDisplay.innerHTML = 'Lat: -- | Lon: --'; });

    });
    </script>
{% endblock %}