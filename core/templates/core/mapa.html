{% extends 'core/base_app.html' %}
{% load static %}

{% block content %}
    <div class="page-header">
        <h2 class="mb-0">(Beta) Mapa Interativo</h2>
        <p class="text-muted">Visualize, gerencie e planeje as áreas verdes da cidade.</p>
    </div>

    <div class="card map-card-container">
        <!-- Onde o mapa em si aparece -->
        <div id="map" data-analisar-url="{% url 'analisar_area_api' %}"></div>

        <!-- ======================================================================= -->
        <!-- AQUI O NOSSO PALCO: O PAINEL DE CIDADES -->
        <!-- O JS vai procurar essa div pra montar o menu aqui dentro. -->
        <!-- ======================================================================= -->
        <div id="city-selector-panel" class="map-overlay-panel map-overlay--topcenter">
            <label for="city-select" class="form-label small mb-1">Visualizando cidade:</label>
            <div id="city-select-container">
                <!-- O JavaScript vai criar o menu <select> aqui dentro -->
            </div>
            <div id="map-status" class="small text-muted mt-1" style="font-style: italic;"></div>
        </div>
        <!-- ======================================================================= -->

        <!-- Painel de Detalhes que você já tinha -->
        <div id="details-panel" class="map-overlay-panel d-none">
            <div class="d-flex justify-content-between align-items-center">
                <h6 id="details-title" class="mb-0 text-truncate">Detalhes</h6>
                <button id="close-details-btn" type="button" class="btn-close btn-sm"></button>
            </div>
            <hr class="my-2">
            <div id="details-content"></div>
        </div>
        
        <!-- Display de Coordenadas que você já tinha -->
        <div id="coords-display" class="map-coords-display">
            Lat: -- | Lon: --
        </div>
    </div>

    <!-- 
    =================================================
    DAQUI PRA BAIXO, NADA MUDA.
    Todos os seus Modals (Janelas Pop-up) continuam aqui.
    =================================================
    -->

    <!-- Modal para Formulário de Área -->
    <div class="modal fade" id="areaFormModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Detalhes da Nova Área</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="area-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">{{ form_area.nome.label }}</label>
                            {{ form_area.nome }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ form_area.tipo.label }}</label>
                            {{ form_area.tipo }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ form_area.status.label }}</label>
                            {{ form_area.status }}
                        </div>
                         <div class="mb-3">
                            <label class="form-label">{{ form_area.especies.label }}</label>
                            {{ form_area.especies }}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-principal-acao" id="saveAreaButton">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Salvar Área
                    </button>
                    <button type="button" class="btn btn-danger-outline d-none" id="deleteAreaButton">Deletar Área</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Árvore -->
    <div class="modal fade" id="addTreeModal" tabindex="-1" aria-labelledby="addTreeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTreeModalLabel">Adicionar Nova Árvore</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-tree-form">
                        {% csrf_token %}
                        <input type="hidden" id="tree-lat" name="latitude">
                        <input type="hidden" id="tree-lon" name="longitude">

                        <div class="mb-3">
                            <label for="tree-especie" class="form-label">Espécie</label>
                            <select class="form-select form-control-custom" id="tree-especie" name="especie" required style="width: 100%;">
                                <option value="" selected disabled>Selecione uma espécie...</option>
                                {% for especie in especies_catalogo %}
                                    <option value="{{ especie.id }}">{{ especie.nome_popular }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="tree-saude" class="form-label">Estado de Saúde</label>
                            <select class="form-select form-control-custom" id="tree-saude" name="saude">
                                <option value="BOA">Boa</option>
                                <option value="MEDIA">Média</option>
                                <option value="RUIM">Ruim</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="tree-observacoes" class="form-label">Observações</label>
                            <textarea class="form-control form-control-custom" id="tree-observacoes" name="observacoes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-principal-acao" id="submitNewTree"> <i class="bi bi-check-circle-fill me-1"></i>
                        Salvar Árvore
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmar Deleção -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p>Tem certeza que deseja apagar a árvore #<strong id="tree-id-placeholder"></strong> permanentemente?</p>
                    <p class="text-danger small">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger-outline" id="confirm-delete-btn">
                        <i class="bi bi-trash-fill me-1"></i> Sim, Apagar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container para os Toasts (notificações) -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>

    <!-- Passando os dados do Django para o JavaScript -->
    {{ arvores_data|json_script:"arvores-data-json" }}
    {{ solicitacoes_data|json_script:"solicitacoes-data-json" }}
    {{ areas_data|json_script:"areas-data-json" }}
    {{ solicitacao_foco_id|json_script:"solicitacao-foco-id" }}
    {{ area_foco_id|json_script:"area-foco-id" }}

{% endblock %}

{% block scripts %}
    <!-- Carregando o nosso JavaScript mágico -->
    <script src="{% static 'core/js/mapa.js' %}"></script>
{% endblock %}
